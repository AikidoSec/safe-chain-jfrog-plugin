import { ECOSYSTEM_JS, ECOSYSTEM_PY } from '../consts';

const malwareDatabaseUrls = {
  [ECOSYSTEM_JS]: 'https://malware-list.aikido.dev/malware_predictions.json',
  [ECOSYSTEM_PY]: 'https://malware-list.aikido.dev/malware_pypi.json',
} as const;

interface MalwarePackage {
  package_name: string;
  version: string;
  reason: string;
}

interface MalwareDatabaseResponse {
  malwareDatabase: MalwarePackage[];
  version: string | undefined;
}

/**
 * Fetches the malware database for the current ecosystem.
 * @returns {Promise<MalwareDatabaseResponse>}
 */
export async function fetchMalwareDatabase(
  ecosystem: string
): Promise<MalwareDatabaseResponse> {
  const malwareDatabaseUrl =
    malwareDatabaseUrls[ecosystem as keyof typeof malwareDatabaseUrls];
  const response = await fetch(malwareDatabaseUrl);

  if (!response.ok) {
    throw new Error(
      `Error fetching ${ecosystem} malware database: ${response.statusText}`
    );
  }

  try {
    const malwareDatabase = await response.json();
    return {
      malwareDatabase: malwareDatabase as MalwarePackage[],
      version: response.headers.get('etag') ?? undefined,
    };
  } catch (error) {
    if (error instanceof Error) {
      throw new Error(`Error parsing malware database: ${error.message}`);
    }
    throw new Error('Error parsing malware database: Unknown error');
  }
}
