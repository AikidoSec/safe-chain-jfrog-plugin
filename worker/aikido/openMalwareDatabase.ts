import { ECOSYSTEM_PY } from '../consts';
import { fetchMalwareDatabase } from './fetchMalwareDatabase';

type MalwareDatabase = {
  version: string;
  isMalware: (name: string, version: string) => boolean;
};

const MALWARE_STATUS_OK = 'OK';

function normalizePackageName(name: string, ecosystem: string): string {
  if (ecosystem === ECOSYSTEM_PY) {
    return name.toLowerCase().replace(/[-_.]+/g, '-');
  }
  return name;
}

function isMalwareStatus(status: string): boolean {
  return status !== MALWARE_STATUS_OK;
}

export async function openMalwareDatabase(
  ecosystem: string
): Promise<MalwareDatabase> {
  const { malwareDatabase, version } = await fetchMalwareDatabase(ecosystem);

  function getPackageStatus(name: string, version: string): string {
    const normalizedName = normalizePackageName(name, ecosystem);
    const packageData = malwareDatabase.find((pkg) => {
      const normalizedPkgName = normalizePackageName(
        pkg.package_name,
        ecosystem
      );
      const isNameMatch = normalizedPkgName === normalizedName;
      const isVersionMatch = pkg.version === version || pkg.version === '*';
      return isNameMatch && isVersionMatch;
    });
    if (!packageData) {
      return MALWARE_STATUS_OK;
    }
    return packageData.reason;
  }

  return {
    version,
    isMalware: (name: string, version: string) => {
      const status = getPackageStatus(name, version);
      return isMalwareStatus(status);
    },
  };
}
