import dev.aikido_plugins.safe_chain_jfrog.database.MalwareDatabase;
import dev.aikido_plugins.safe_chain_jfrog.database.MalwarePackage;
import org.junit.jupiter.api.Test;

import java.util.List;

import static org.junit.jupiter.api.Assertions.assertFalse;
import static org.junit.jupiter.api.Assertions.assertTrue;

public class MalwareDatabaseTest {

  @Test
  void testIsMalware_ExactMatch() {
    MalwarePackage pkg = new MalwarePackage("lodash", "4.17.21", "Malicious code detected");
    MalwareDatabase db = new MalwareDatabase(List.of(pkg), "v1", "js");
    assertTrue(db.isMalware("lodash", "4.17.21"));
  }

  @Test
  void testIsMalware_WildcardVersion() {
    MalwarePackage pkg = new MalwarePackage("lodash", "*", "Malicious code detected");
    MalwareDatabase db = new MalwareDatabase(List.of(pkg), "v1", "js");
    assertTrue(db.isMalware("lodash", "4.17.21"));
  }

  @Test
  void testIsMalware_NoMatch() {
    MalwarePackage pkg = new MalwarePackage("lodash", "4.17.21", "Malicious code detected");
    MalwareDatabase db = new MalwareDatabase(List.of(pkg), "v1", "js");
    assertFalse(db.isMalware("react", "16.0.0"));
  }

  @Test
  void testIsMalware_DashNormalization() {
    MalwarePackage pkg = new MalwarePackage("some-package", "*", "Malicious code detected");
    MalwareDatabase db = new MalwareDatabase(List.of(pkg), "v1", "py");
    assertTrue(db.isMalware("some.package", "1.0.0")); // Normalized to "some-package"
  }

  @Test
  void testIsMalware_UnderscoreNormalization() {
    MalwarePackage pkg = new MalwarePackage("some-package", "*", "Malicious code detected");
    MalwareDatabase db = new MalwareDatabase(List.of(pkg), "v1", "py");
    assertTrue(db.isMalware("some_package", "1.0.0")); // Normalized to "some-package"
  }

  @Test
  void testIsMalware_MixedNormalization() {
    MalwarePackage pkg = new MalwarePackage("some-package-name", "*", "Malicious code detected");
    MalwareDatabase db = new MalwareDatabase(List.of(pkg), "v1", "py");
    assertTrue(db.isMalware("some.package_name", "1.0.0")); // Normalized to "some-package-name"
  }

  @Test
  void testIsMalware_EmptyDatabase() {
    MalwareDatabase db = new MalwareDatabase(List.of(), "v1", "js");
    assertFalse(db.isMalware("lodash", "4.17.21"));
  }
}
