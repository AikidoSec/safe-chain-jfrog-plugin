package dev.aikido_plugins.safe_chain_jfrog.database;

import java.util.List;

public record MalwareDatabase(List<MalwarePackage> malwareDatabase, String version, String ecosystem) {
  /**
   * isMalware func
   * @param name the name of the package, as extracted from the url
   * @param version the version of the package.
   * @return a boolean value, where true means it's malware.
   */
  public boolean isMalware(String name, String version) {
    String normalizedName = normalizePackageName(name, ecosystem);

    for (MalwarePackage pkg : malwareDatabase) {
      String normalizedPkgName = normalizePackageName(pkg.packageName(), ecosystem);
      boolean isNameMatch = normalizedPkgName.equals(normalizedName);
      boolean isVersionMatch = pkg.version().equals(version) || pkg.version().equals("*");
      if (isNameMatch && isVersionMatch) {
        return true;
      }
    }

    return false;
  }

  // make public for easy testing
  public String normalizePackageName(String name, String ecosystem) {
    if ("py".equals(ecosystem)) {
      return name.toLowerCase().replaceAll("[-_.]+", "-");
    }
    return name;
  }
}
