import utils.HttpClient

class MalwareDatabase {
  String version
  Closure isMalware

  static MalwareDatabase openMalwareDatabase(String ecosystem, HttpClient httpClient) {
    def response = httpClient.get("https://malware-list.aikido.dev/malware_predictions.json")
    def malwareDatabase = response.data
    def databaseVersion = response.headers['ETag'] ?: "unknown"

    def isMalwareClosure = { String name, String version ->
      def normalizedName = name.toLowerCase().replace(/[-_.]+/g, '-')
      def packageData = malwareDatabase.find { pkg ->
        def normalizedPkgName = pkg.package_name.toLowerCase().replace(/[-_.]+/g, '-')
        def isNameMatch = normalizedPkgName == normalizedName
        def isVersionMatch = pkg.version == version || pkg.version == '*'
        isNameMatch && isVersionMatch
      }
      return packageData && packageData.reason != 'OK'
    }.bind(httpClient)

    return new MalwareDatabase(version: databaseVersion, isMalware: isMalwareClosure)
  }
}
